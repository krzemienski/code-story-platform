# Plan 01-02: Intent API Routes

## Objective

Create CRUD API endpoints for managing story intents - allowing creation, retrieval, update, and deletion of intent records.

## Context

- Spec reference: `/home/nick/code-story/docs-plans-prompts-specs/codestory.md`
- Database schema: `story_intents` table (exists per 01-01)
- Framework: Next.js App Router API routes

## Pre-conditions

- [x] story_intents table exists (validated in 01-01)
- [x] TypeScript types exist (validated in 01-01)
- [ ] Supabase client configured

## Tasks

### Task 1: Create Intent CRUD API Route

**Type**: code
**Files**: `app/api/intents/route.ts`

**Action**: Create API route with:
- GET: List user's intents
- POST: Create new intent

\`\`\`typescript
import { createClient } from '@/lib/supabase/server'
import { NextResponse } from 'next/server'

export async function GET() {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()

  if (!user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const { data, error } = await supabase
    .from('story_intents')
    .select('*')
    .eq('user_id', user.id)
    .order('created_at', { ascending: false })

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 })
  }

  return NextResponse.json(data)
}

export async function POST(request: Request) {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()

  if (!user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const body = await request.json()

  const { data, error } = await supabase
    .from('story_intents')
    .insert({
      user_id: user.id,
      repository_id: body.repository_id,
      intent_category: body.intent_category,
      user_description: body.user_description,
      focus_areas: body.focus_areas || [],
      expertise_level: body.expertise_level || 'intermediate',
      conversation_history: body.conversation_history || [],
    })
    .select()
    .single()

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 })
  }

  return NextResponse.json(data, { status: 201 })
}
\`\`\`

**Verify**: File exists, exports GET and POST functions

**Done**: [ ]

---

### Task 2: Create Intent Single Resource Route

**Type**: code
**Files**: `app/api/intents/[id]/route.ts`

**Action**: Create dynamic route for single intent operations:
- GET: Retrieve single intent
- PATCH: Update intent
- DELETE: Delete intent

**Verify**: File exists, exports GET/PATCH/DELETE functions

**Done**: [ ]

---

### Task 3: Verify Intent Chat API Exists

**Type**: validation
**Files**: `app/api/chat/intent/route.ts`

**Action**: Confirm AI conversation endpoint exists for intent gathering

**Verify**: File exists with POST handler

**Done**: [ ]

---

## Validation Gates

### Gate 1: API Route Files Exist
\`\`\`bash
ls -la app/api/intents/route.ts app/api/intents/[id]/route.ts 2>/dev/null
\`\`\`
**Expected**: Both files exist

### Gate 2: Intent Chat Route Exists
\`\`\`bash
ls -la app/api/chat/intent/route.ts
\`\`\`
**Expected**: File exists

### Gate 3: Build Passes
\`\`\`bash
pnpm build 2>&1 | grep -E "(error|Error)" | head -20
\`\`\`
**Expected**: No new errors introduced

## Acceptance Criteria

- [ ] `app/api/intents/route.ts` exists with GET/POST
- [ ] `app/api/intents/[id]/route.ts` exists with GET/PATCH/DELETE
- [ ] `app/api/chat/intent/route.ts` exists
- [ ] Build succeeds (or pre-existing errors only)

## Post-conditions

- Intent CRUD operations available via REST API
- AI conversation endpoint available for intent gathering
