# Plan 01-06: Integration

## Objective

Connect intent capture to story generation, ensuring the full pipeline uses user intent for tailored content.

## Context

- Gap from 01-05: Generate route doesn't fetch intent data
- Target: Stories should reflect user's stated learning goals
- Files: `app/api/stories/generate/route.ts`

## Pre-conditions

- [x] Intent DB schema exists (01-01)
- [x] Intent captured via chat (01-03)
- [x] Intent stored with story (dashboard/new/page.tsx:337)
- [ ] Intent data used in generation

## Tasks

### Task 1: Enhance Generate Route to Fetch Intent

**Type**: code
**Files**: `app/api/stories/generate/route.ts`

**Action**: Add intent data fetching:
\`\`\`typescript
// After fetching story (around line 94)
let intentContext = ""
if (story.intent_id) {
  const { data: intent } = await supabase
    .from("story_intents")
    .select("user_description, focus_areas, intent_category")
    .eq("id", story.intent_id)
    .single()

  if (intent) {
    intentContext = `
USER'S LEARNING GOAL: ${intent.user_description || 'General exploration'}
FOCUS AREAS: ${intent.focus_areas?.join(", ") || 'All areas'}
INTENT TYPE: ${intent.intent_category || 'general'}`
  }
}
\`\`\`

**Verify**: Intent fetched when intent_id exists

**Done**: [ ]

---

### Task 2: Include Intent in Prompt Context

**Type**: code
**Files**: `app/api/stories/generate/route.ts`

**Action**: Add intentContext to the story generation prompt (around line 297):
\`\`\`typescript
${intentContext}

REPOSITORY: ${repoOwner}/${repoName}
\`\`\`

**Verify**: Intent context included in prompt

**Done**: [ ]

---

### Task 3: Validate End-to-End Flow

**Type**: validation

**Action**: Verify complete flow:
1. User describes intent in chat
2. Intent stored in story_intents
3. Story created with intent_id
4. Generate route fetches intent
5. Prompt includes intent context

**Verify**: All steps connected

**Done**: [ ]

---

## Validation Gates

### Gate 1: Intent Fetch Code Added
\`\`\`bash
grep -c "story_intents" app/api/stories/generate/route.ts
\`\`\`
**Expected**: > 0

### Gate 2: Intent Context in Prompt
\`\`\`bash
grep -E "intentContext|LEARNING.GOAL|FOCUS.AREAS" app/api/stories/generate/route.ts
\`\`\`
**Expected**: Matches found

### Gate 3: Build Passes
\`\`\`bash
pnpm build 2>&1 | grep -E "error TS" | head -5
\`\`\`
**Expected**: No new TypeScript errors

## Acceptance Criteria

- [ ] Generate route fetches intent record
- [ ] Intent data included in prompt context
- [ ] Build succeeds
- [ ] End-to-end flow validated

## Post-conditions

- Stories tailored to user's specific learning goals
- Focus areas influence content prioritization
- Phase 01 complete - Intent-Driven Experience achieved
