# Plan 01-01: Intent Database Schema

## Objective

Create the database schema for storing user intents - the structured capture of what users want to learn from a codebase.

## Context

- Spec reference: `/home/nick/code-story/docs-plans-prompts-specs/codestory.md` (lines 2484-2496)
- Current schema: `scripts/001_create_codestory_tables.sql`
- Database: Supabase PostgreSQL

## Pre-conditions

- [ ] Supabase project configured
- [ ] Existing migrations work
- [ ] `pnpm build` passes

## Tasks

### Task 1: Create story_intents migration file

**Type**: database
**Files**: `scripts/008_create_story_intents.sql`

**Action**: Create SQL migration with:
\`\`\`sql
CREATE TABLE story_intents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
    repository_id UUID REFERENCES code_repositories(id) ON DELETE CASCADE,
    intent_category VARCHAR(100) NOT NULL,
    user_description TEXT,
    focus_areas JSONB DEFAULT '[]',
    expertise_level VARCHAR(50) DEFAULT 'intermediate',
    conversation_history JSONB DEFAULT '[]',
    generated_plan JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- RLS policies
ALTER TABLE story_intents ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own intents" ON story_intents
    FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can create own intents" ON story_intents
    FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own intents" ON story_intents
    FOR UPDATE USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own intents" ON story_intents
    FOR DELETE USING (auth.uid() = user_id);

-- Index for faster queries
CREATE INDEX idx_story_intents_user_id ON story_intents(user_id);
CREATE INDEX idx_story_intents_repository_id ON story_intents(repository_id);
\`\`\`

**Verify**: File exists, SQL is valid

**Done**: [ ]

---

### Task 2: Update stories table to reference intents

**Type**: database
**Files**: `scripts/009_add_intent_to_stories.sql`

**Action**: Create migration to add intent_id foreign key:
\`\`\`sql
ALTER TABLE stories
ADD COLUMN intent_id UUID REFERENCES story_intents(id) ON DELETE SET NULL;

CREATE INDEX idx_stories_intent_id ON stories(intent_id);
\`\`\`

**Verify**: File exists, SQL is valid

**Done**: [ ]

---

### Task 3: Add TypeScript types for intents

**Type**: code
**Files**: `lib/types.ts`

**Action**: Add Intent type definition:
\`\`\`typescript
export interface StoryIntent {
  id: string;
  user_id: string;
  repository_id: string;
  intent_category: IntentCategory;
  user_description: string | null;
  focus_areas: string[];
  expertise_level: ExpertiseLevel;
  conversation_history: ConversationMessage[];
  generated_plan: StoryPlan | null;
  created_at: string;
  updated_at: string;
}

export type IntentCategory =
  | 'architecture_understanding'
  | 'onboarding_deep_dive'
  | 'feature_focus'
  | 'code_review_prep'
  | 'learning_patterns'
  | 'api_documentation'
  | 'bug_investigation'
  | 'migration_planning';

export type ExpertiseLevel = 'beginner' | 'intermediate' | 'expert';

export interface ConversationMessage {
  role: 'user' | 'assistant';
  content: string;
  timestamp: string;
}

export interface StoryPlan {
  title: string;
  estimated_duration_minutes: number;
  chapters: ChapterPlan[];
  narrative_style: NarrativeStyle;
  voice_recommendation: string;
}

export interface ChapterPlan {
  number: number;
  title: string;
  duration_minutes: number;
  focus_files: string[];
  key_concepts: string[];
}
\`\`\`

**Verify**: `pnpm build` passes, types exported

**Done**: [ ]

---

## Validation Gates

### Gate 1: Build Validation
\`\`\`bash
pnpm build
\`\`\`
**Expected**: Exit code 0, no TypeScript errors

### Gate 2: SQL Validation
\`\`\`bash
# Check SQL syntax (manual via Supabase SQL editor or local pg)
\`\`\`
**Expected**: SQL parses without errors

### Gate 3: Type Export Validation
\`\`\`bash
grep -q "StoryIntent" lib/types.ts && echo "PASS" || echo "FAIL"
\`\`\`
**Expected**: PASS

## Acceptance Criteria

- [ ] `scripts/008_create_story_intents.sql` exists with valid SQL
- [ ] `scripts/009_add_intent_to_stories.sql` exists with valid SQL
- [ ] `lib/types.ts` contains StoryIntent type and related types
- [ ] `pnpm build` succeeds
- [ ] Types can be imported: `import { StoryIntent } from '@/lib/types'`

## Post-conditions

- Migration files ready to apply to Supabase
- TypeScript types available for use in API routes and components
- No regressions in existing functionality

## Checkpoint

**Type**: checkpoint:human-verify
**When**: After all tasks complete
**Action**: User applies migrations to Supabase and confirms tables created
